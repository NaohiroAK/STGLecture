## 17. BGMを流そう

### 概要

本章では、このゲームの背景にBGMを流す方法について解説します。

### BGMの再生方法

AltseedでBGMを鳴らす方法は、効果音の場合とほぼ同じです。音声ファイルをロードし、再生したいタイミングで決められたメソッドを呼び出すことで再生します。また、BGMをループさせるための機能も、Altseedには備わっています。

#### ロード

AltseedでBGMをロードする方法は、効果音の時とほぼ同じです。ただし１つだけ違う点があります。それは、`CreateSoundSource`メソッドに渡す引数です。BGMの場合は基本的に次のようにメソッドを呼び出します。

```cs
SoundSource bgm = Engine.Sound.CreateSoundSource("Resources/Bgm.ogg", false);
```

第２引数に渡す値が、効果音の時は`true`だったのが、BGMでは`false`になります。この引数は音声ファイルを一気に解凍するかどうかを指定しています。`false`を指定すると、一気には読み込まず再生しながら必要な分だけ解凍していきます。詳しくは、[16章](./16.md)の「もっと詳しく」の節で解説しています。

#### 再生

そして、実際にBGMを再生するには、再生を開始したいタイミングに次の命令を書きます。これは効果音の時と同じ命令です。

```cs
// bgmはロードした音声を保持している変数
Engine.Sound.Play(bgm);
```

#### ループ

BGMは、再生が終了した時に何度も最初または途中から再生し直したい場合があります。そのような場合は、次のようなコードを記述します。

```cs
// bgmはロードした音声を保持している変数
bgm.IsLoopingMode = true;		// ループ機能を有効にする
bgm.LoopStartingPoint = 10.0f;	// ループの開始地点を指定する(秒数)
bgm.LoopEndPoint = 101.7f		// ループの終了地点を指定する(秒数)
```

`SoundSource.IsLoopingMode`を`true`に設定すると、ループ機能が有効になります。有効にすると、音声の再生が`LoopEndPoint`に指定した時間に達したとき、`LoopStartingPoint`に指定した時間からふたたび再生が始まります。実のところ、効果音でもループをすることはできます。

### ゲームにBGMを付ける

今回は、タイトルやゲームオーバー画面は省いて、STG部分にだけBGMを付けることにします。
BGMのファイルは１つだけ用意しました。これを３つのステージで鳴らすようにしましょう。
ステージを扱う部分はGameSceneクラスに書かれていますので、GameSceneクラスのコンストラクタでBGMをロードすることにします。
GameSceneクラスのコードに、次のようにBGMをロードする処理を追加します。

```diff
// ゲーム画面を表すシーン
class GameScene : asd.Scene
{
    // 敵の出現するレイヤーを持つ
    asd.Layer2D gameLayer;

    // ステージの最後にボスが出る
    Boss boss;

    // ステージ数を管理
    int stage;

    // ゲームの経過時間を管理
    int count;

    // ステージごとに敵を入れておくキュー
    Queue<Enemy>[] enemyQueues = new Queue<Enemy>[3];

    // プレイヤーのインスタンス
    Player player = null;

    // シーンを変更中か?
    bool isSceneChanging = false;

+   // BGM
+   asd.SoundSource bgm;

+   // 再生中のBGMを扱うための値。
+   int? playingBgmId;

    protected override void OnStart()
    {
		(中略)

        // プレイヤーのインスタンスを生成し、GameScene に登録する。
        player = new Player();

        // レイヤーにプレイヤーのインスタンスを追加する。
        gameLayer.AddObject(player);

        // stage を初期化する
        initAllStage();

+   	// BGMを読み込む。
+   	bgm = asd.Engine.Sound.CreateSoundSource("Resources/Bgm.ogg", false);

+   	// BGMがループするように設定する。
+   	bgm.IsLoopingMode = true;

+   	// BGMは流れていないのでハンドラーはnull
+   	playingBgmId = null;
    }
	
	(中略)
}
```

次に、実際にBGMを鳴らす部分を書きましょう。

```diff
private void updateStage()
{
+   // 60カウントのときに
+   if(count == 60)
+   {
+   	// BGMを再生。再生のIDを保持しておく
+   	playingBgmId = asd.Engine.Sound.Play(bgm);
+   }

    // ステージに対応するキューが空でないならば
    if (enemyQueues[stage].Count > 0)
    {
        // countが144の倍数の時
        // (調整用に一定の時間(count>100)を置く)
        if (count % 144 == 0 && count > 100)
        {
            // 敵を出現させる
            gameLayer.AddObject(enemyQueues[stage].Dequeue());
        }
    }

    // そのステージの敵が出現し終わったら
    else
    {
        // ボスが出現してないときに
        if (boss == null)
        {
            // ボスをステージに出現させる
            boss = new Boss(new asd.Vector2DF(320.0f, 0.0f), player);

            // ボスをレイヤーに追加する
            gameLayer.AddObject(boss);
        }

        else if (!boss.IsAlive && stage < 2)
        {
            // ボスを初期化しておいて
            boss = null;

            // ステージを先に進める
            ++stage;
            
            // ステージが進んだら count を 0 に戻す。
            count = 0;

+   		// BGMが再生中ならば
+   		if (playingBgmId.HasValue)
+   		{
+   			// BGMをフェードアウトする。
+   			asd.Engine.Sound.FadeOut(playingBgmId.Value, 0.5f);
+   			// BGMが鳴っていないのでIDはnull
+   			playingBgmId = null;
+   		}
        }
    }
    // onUpdate ごとに count を進める
    ++count;
}
```

ゲームオーバー画面に遷移する際もBGMを止める必要があります。

```diff
protected override void OnUpdated()
{
    // もしシーンが変更中でなく、プレイヤーが倒されていたら処理を行う。
    if (!isSceneChanging && !player.IsAlive)
    {
+   	if (playingBgmId.HasValue)
+   	{
+   		asd.Engine.Sound.FadeOut(playingBgmId.Value, 1.0f);
+   		playingBgmId = null;
+   	}

        // ゲームオーバー画面に遷移する。
        asd.Engine.ChangeSceneWithTransition(new GameOverScene(), new asd.TransitionFade(1.0f, 1.0f));

        // シーンを変更中にする。
        isSceneChanging = true;
    }

    // stage を更新する 
    updateStage();

}
```

ループ処理をしているので、再生が終わっても途中からまた再生が始まるはずです。実行結果は、当講座ページでは音をだすことができないので皆さんの耳で確かめてみてください。

### まとめ

本章では、ゲームにBGMを付けることができました。効果音とBGMによって、ゲームがよりゲームらしくなったかと思います。次の章では、敵の弾を消すことの出来るボムを実装しましょう。