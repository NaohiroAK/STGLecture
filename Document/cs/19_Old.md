## 19. スコア機能を付けてみよう

### 概要

前回までの内容で、ゲームは殆ど完成です。
しかし、折角「スコア」つきのゲームをプレイしたするには、ハイスコアの記録等はどこかに保存されるようにしたいところです。
そこで今回は、「ハイスコアの情報を保存・読み込みできるようにする」という機能を実装してみましょう。

### C#によるファイル入出力

ハイスコアのデータを保存・読み込みするためには様々な方法がありますが、本章では簡単のために.NET FrameworkのSystem.IO.StreamReader、System.IO.StreamWriterを利用してみます。

### ハイスコアを書き出してみる

新しくScore.csを作り、以下のように書いてみましょう。

<書き出しコード>

### ハイスコアを読み込んでみる

Score.csのScoreクラス内に、以下のReadメソッドを追加してみましょう。

<読み込みコード>

### 多くの情報を保存するには

さて、このままでは1行分（1つ）のデータしか保存できていません。
ゲームにおいて、保存したい情報は1つではなく多数（例えば、プレイヤーの名前やハイスコアの取得日時など）であることが多いですから、1つのファイルに多くの情報を格納する方法をいくつか紹介しておきたいと思います。

#### StreamReader/StreamWriter を利用する方法

本章で扱ってきたStreamReader/StreamWriterは、StreamReader.ReadLine()で1行ずつの読み込み、StreamWriter.WriteLine()で1行ずつの書き出しを行います。
そのため、読み込み・書き出しをしたいデータの数だけReadLine/WriteLineを呼べば、格納するデータの数が多くなってもデータを読み込んだり、書きこんだりすることができます。

ただしこの方法では、扱うデータの数が増えるとそれだけReadLine/WriteLineを繰り返さなければならず、例えばキーコンフィグ等の情報も保存しようとすると大変不便です。そのような場合は、次に挙げる方法を利用することで、大変簡単に多量のデータを取り扱うことができます。

#### Serialize を利用する方法

StreamReader/StreamWriter を利用する方法における問題点を解消するのが、この方法です。簡単に言えば、「保存するデータを記録するためのクラスを作り、それを丸ごとファイルに保存してしまおう」というものです。

さて、現状ではScoreクラス内にスコアに関する情報がまとまっていますから、Scoreクラスの宣言の前の行に[Serializable]と記述してみましょう。下準備はこれだけで終わりなので、次は読み込み・書き出しを実装してみます。

<コード>

saveメソッド・readメソッドをこのように書き換えることで、読み込み・書き出しの部分の記述も完了です。これでクラス内の全ての情報を保存したり、読み込んだりすることが出来るようになります。
StreamReader/StreamWriter を利用する方法と比較すると、扱うデータ量が増減してもコードを書き換える必要がないため大変便利です……が、「クラスのプロパティの数や名前に変更が生じた場合、今までに生成したファイルは読み込めなくなる」という問題点があります。そのため、開発の最中など、頻繁に扱うデータの数が変わる場合は注意しなければなりません。

### チート対策
ところで、StreamReader/StreamWriter を利用する方法においては、察しの良い方は「保存されたファイルを書き換えてしまえば、ハイスコアを任意の値にしたり、場合によってはチートをしたりできるのではないか？」と気付いたことかと思います。実は全く以ってその通りで、データを平文としてファイルに記述する場合、意図せぬ書き換えなどにより「チート」が発生してしまう可能性が高くなってしまいます。
そこで考えられる方法として、上記のように Serialize（バイナリ列なので、簡単には書き換えられない）を利用する方法がありますが、これには「扱うデータの数が変わると、今までのデータが使えなくなる」という問題点があります。では、「容易にはデータファイルの書き換えができないように」した上で、「以前に生成されたデータとの互換性を保つ」ためにはどうすれば良いのでしょうか。

これを解決する最も簡単な手法として、本項では「StreamReader/StreamWriter を利用して生成したファイルを暗号化し、読み込み時に復号する」という方法を紹介しておきます。
先程「Serialize を利用する方法」の部分でコードに加えた変更を元に戻し、「StreamReader/StreamWriter を利用する方法」を実装し終えた段階にしてみましょう。暗号化・復号化には今回は.NETのDESCryptoServiceProviderを利用しますが、他にも異なる暗号化アルゴリズムを利用したクラスが存在するため、詳しく知りたい方は調べてみると良いでしょう。

さて、Score.csに以下のコードを書き足してみます。

<コード>

このようにすることで、ファイルを暗号化して保存し、復号化して読み込むように実装することが出来ました。